<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Imposter Guesser</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      background-color: #0a0a0a;
      color: white;
      font-family: 'Poppins', sans-serif;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    h1 {
      font-size: 2.5em;
      margin-bottom: 20px;
      color: #00ffff;
      text-shadow: 0 0 10px #00ffff;
    }
    button {
      background: none;
      border: 2px solid #00ffff;
      border-radius: 50px;
      color: #00ffff;
      padding: 20px 60px;
      font-size: 1.5em;
      cursor: pointer;
      text-shadow: 0 0 5px #00ffff;
      box-shadow: 0 0 15px #00ffff;
      transition: 0.2s;
    }
    button:hover {
      background: #00ffff;
      color: black;
      box-shadow: 0 0 30px #00ffff;
    }
    input {
      margin: 10px;
      padding: 10px;
      font-size: 1em;
      border-radius: 8px;
      border: none;
      outline: none;
    }
    #message {
      margin-top: 30px;
      font-size: 1.3em;
      color: #fff;
    }
  </style>
</head>
<body>
  <h1>🎭 Imposter Guesser</h1>
  <div id="setup">
    <input type="text" id="wordInput" placeholder="Enter secret word" />
    <input type="number" id="playersInput" placeholder="Number of players" />
    <button id="createBtn">Create Game Link</button>
  </div>

  <div id="revealSection" style="display: none;">
    <button id="revealBtn">REVEAL</button>
    <div id="message"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://zaqiefpfwnwnsflfbloq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphcWllZnBmd253bnNmbGZibG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNTEyMjksImV4cCI6MjA3NjcyNzIyOX0.sopNAnbCiOmJimpnvf2GOI8WJkxaPgAk7Clv4L-aKAg";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function createRoom(word, total) {
      const roomId = Math.random().toString(36).substring(2, 8);
      const imposter = Math.floor(Math.random() * total) + 1;

      const { data, error } = await supabase
        .from("table editor")
        .insert([{ room_id: roomId, word, total, imposter, joined: 0 }]);

      if (error) {
        alert("❌ Error creating room: " + error.message);
        console.error(error);
        return null;
      }
      return roomId;
    }

    async function joinRoom(roomId) {
      const { data: rooms } = await supabase
        .from("table editor")
        .select("*")
        .eq("room_id", roomId)
        .limit(1);

      const room = rooms?.[0];
      if (!room) {
        document.getElementById("message").textContent = "Room not found.";
        return;
      }

      if (room.joined >= room.total) {
        document.getElementById("message").textContent = "Room is full!";
        return;
      }

      const playerNumber = room.joined + 1;
      await supabase.from("table editor").update({ joined: playerNumber }).eq("room_id", roomId);

      document.getElementById("setup").style.display = "none";
      document.getElementById("revealSection").style.display = "block";

      document.getElementById("revealBtn").onclick = () => {
        const msg = document.getElementById("message");
        if (playerNumber === room.imposter) {
          msg.textContent = "😈 Oh no! You are the IMPOSTER!";
        } else {
          msg.textContent = "🗝️ Your word: " + room.word;
        }
        document.getElementById("revealBtn").disabled = true;
      };
    }

    // Handle create game button
    document.getElementById("createBtn").onclick = async () => {
      const word = document.getElementById("wordInput").value.trim();
      const total = parseInt(document.getElementById("playersInput").value);
      if (!word || !total) {
        alert("Enter both word and number of players!");
        return;
      }

      const roomId = await createRoom(word, total);
      if (roomId) {
        const link = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
        navigator.clipboard.writeText(link);
        alert("✅ Link copied! Share it with players:\n" + link);
        window.location.search = `?room=${roomId}`;
      }
    };

    // Auto-join if opened via shared link
    const params = new URLSearchParams(window.location.search);
    const roomParam = params.get("room");
    if (roomParam) {
      joinRoom(roomParam);
    }
  </script>
</body>
</html>
